#!/usr/bin/env python3
"""
Josephson 方程式 lmfit 參數設定詳細說明
===========================================

這個檔案詳細說明了 Complete Josephson Equation 擬合中使用的 lmfit 參數設定，
包括初始值估計和參數範圍約束。

作者：GitHub Copilot
日期：2025-06-03
"""

print("📋 Josephson 方程式 lmfit 參數設定說明")
print("="*60)

josephson_params_info = {
    "I_c": {
        "名稱": "臨界電流 (Critical Current)",
        "物理意義": "Josephson 結在零電壓時的最大超導電流",
        "單位": "安培 (A)",
        "初始值來源": [
            "1. 優先：從 Lomb-Scargle 分析的振幅 (amplitude)",
            "2. 備選：數據標準差的 2 倍 (2 × std(I_s))"
        ],
        "範圍約束": {
            "最小值": "0.1 × |初始值|",
            "最大值": "10 × |初始值|",
            "約束原因": "確保為正值且在合理的物理範圍內"
        },
        "典型值": "1e-6 A (微安級別)"
    },
    
    "f": {
        "名稱": "頻率 (Frequency)",
        "物理意義": "Josephson 振盪的基本頻率，與外部磁通變化相關",
        "單位": "Hz⁻¹ 或無量綱",
        "初始值來源": [
            "1. 優先：從 Lomb-Scargle 分析的最佳頻率 (best_frequency)",
            "2. 備選：1/(2π) ≈ 0.159（默認 Josephson 頻率）"
        ],
        "範圍約束": {
            "最小值": "0.01 × 初始值",
            "最大值": "100 × 初始值",
            "約束原因": "允許頻率在較大範圍內變化，但避免非物理值"
        },
        "典型值": "300000 Hz⁻¹"
    },
    
    "d": {
        "名稱": "相位偏移 (Phase Offset)",
        "物理意義": "外部磁通的相位偏移，反映實驗設置的不完美",
        "單位": "與 phi_ext 相同的單位",
        "初始值來源": [
            "固定初始值：0.0"
        ],
        "範圍約束": {
            "最小值": "-10",
            "最大值": "+10",
            "約束原因": "物理上合理的偏移範圍"
        },
        "典型值": "-0.01"
    },
    
    "phi_0": {
        "名稱": "初始相位 (Initial Phase)",
        "物理意義": "Josephson 振盪的初始相位",
        "單位": "弧度 (rad)",
        "初始值來源": [
            "1. 優先：從 Lomb-Scargle 分析的相位 (phase)",
            "2. 備選：0.0 弧度"
        ],
        "範圍約束": {
            "最小值": "-2π",
            "最大值": "+2π",
            "約束原因": "相位的自然週期性約束"
        },
        "典型值": "0.785 rad (π/4)"
    },
    
    "T": {
        "名稱": "穿透係數 (Transmission Coefficient)",
        "物理意義": "量子穿透的機率，影響 Josephson 結的非線性特性",
        "單位": "無量綱",
        "初始值來源": [
            "固定初始值：0.5（中等穿透）"
        ],
        "範圍約束": {
            "最小值": "0.01",
            "最大值": "0.99",
            "約束原因": "物理上必須在 0 < T < 1 範圍內"
        },
        "典型值": "0.8"
    },
    
    "r": {
        "名稱": "線性趨勢斜率 (Linear Trend Slope)",
        "物理意義": "背景線性變化，可能來自儀器漂移或其他系統效應",
        "單位": "I_s 單位 / phi_ext 單位",
        "初始值來源": [
            "從數據的一階多項式擬合係數估計：np.polyfit(phi_ext, I_s, 1)[0]"
        ],
        "範圍約束": {
            "最小值": "-10 × |初始值|",
            "最大值": "+10 × |初始值|",
            "約束原因": "允許合理的線性變化範圍"
        },
        "典型值": "0.05"
    },
    
    "C": {
        "名稱": "常數偏移 (Constant Offset)",
        "物理意義": "背景電流偏移，可能來自儀器校準或系統偏差",
        "單位": "與 I_s 相同（安培）",
        "初始值來源": [
            "1. 優先：從 Lomb-Scargle 分析的偏移 (offset)",
            "2. 備選：數據的平均值 np.mean(I_s)"
        ],
        "範圍約束": {
            "最小值": "初始值 - 5 × std(I_s)",
            "最大值": "初始值 + 5 × std(I_s)",
            "約束原因": "基於數據變異性的合理偏移範圍"
        },
        "典型值": "1e-5 A"
    }
}

print("\n📊 詳細參數說明：")
print("-" * 60)

for param_name, info in josephson_params_info.items():
    print(f"\n🔧 {param_name}: {info['名稱']}")
    print(f"   物理意義：{info['物理意義']}")
    print(f"   單位：{info['單位']}")
    print(f"   典型值：{info['典型值']}")
    
    print(f"   初始值來源：")
    for source in info['初始值來源']:
        print(f"      • {source}")
    
    print(f"   範圍約束：")
    for constraint, value in info['範圍約束'].items():
        if constraint != '約束原因':
            print(f"      • {constraint}：{value}")
    print(f"      • 約束原因：{info['範圍約束']['約束原因']}")

print("\n" + "="*60)
print("🔬 Complete Josephson 方程式：")
print("="*60)

equation_info = """
I_s(Φ_ext) = [I_c × sin(2πf(Φ_ext-d) - φ_0)] / √[1 - T × sin²((2πf(Φ_ext-d) - φ_0)/2)] + r(Φ_ext-d) + C

其中：
• I_s：輸出超導電流
• Φ_ext：外部磁通（自變數）
• I_c：臨界電流（主要振幅參數）
• f：頻率（決定振盪週期）
• d：相位偏移（校正實驗偏差）
• φ_0：初始相位（相位起點）
• T：穿透係數（非線性修正）
• r：線性趨勢（背景漂移）
• C：常數偏移（基線校正）
"""

print(equation_info)

print("\n🚀 參數估計策略：")
print("-" * 40)

strategy_info = """
1. 📊 Lomb-Scargle 預處理：
   - 去除一階多項式趨勢
   - 自動頻率範圍檢測
   - 高解析度週期圖分析

2. 🎯 智能初始值估計：
   - I_c：從 LS 振幅或數據標準差
   - f：從 LS 最佳頻率
   - φ_0：從 LS 相位
   - C：從 LS 偏移或數據平均
   - r：從線性擬合斜率
   - d, T：物理合理的默認值

3. 🔒 約束範圍設計：
   - 相對約束：基於初始值的倍數關係
   - 絕對約束：基於物理意義的硬限制
   - 自適應約束：基於數據變異性

4. ⚡ L-BFGS-B 優化：
   - 適合有界約束問題
   - 高效的梯度下降算法
   - 自動收斂判斷
"""

print(strategy_info)

print("\n✅ 優勢與特點：")
print("-" * 30)

advantages = """
• 🎯 智能初始估計：結合 Lomb-Scargle 結果提供優質起點
• 🔒 物理約束：確保參數在物理合理範圍內
• ⚡ 高效優化：L-BFGS-B 算法快速收斂
• 📊 自適應範圍：基於數據特性調整約束範圍
• 🔄 備選機制：當 LS 結果不可用時有備選策略
• 📈 統計驗證：提供完整的擬合統計和不確定性評估
"""

print(advantages)

if __name__ == "__main__":
    print(f"\n📋 參數設定說明已生成")
    print(f"   總共 {len(josephson_params_info)} 個參數")
    print(f"   涵蓋完整的 Josephson 方程式")
